# https://github.com/withastro/astro/blob/main/.github/workflows/nightly.yml#L33-L70
# https://github.com/sw-yx/swyxkit/blob/main/.github/workflows/nightly.yml

name: 'Nightly'

on:
  push:
    branches: ['main']
  schedule:
    # Runs at 12:00 UTC daily
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  lockfile:
    if: ${{ github.repository_owner == 'nightconcept' && github.event.label.name != 'manual-CI' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Clear lockfile
        run: rm -rf pnpm-lock.json node_modules

      - name: Install dependencies
        run: pnpm install

      - name: Create Pull Request
        id: createpr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.NIGHTLY_PERSONAL_GITHUB_TOKEN }}
          commit-message: '[ci] update lockfile'
          title: '[ci] update lockfile'
          body: >
            This PR is auto-generated by a nightly GitHub action. 

            It should automatically be merged if tests pass.

      - name: Mark Pull Request for Auto-Merge
        if: steps.createpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v1
        with:
          token: ${{ secrets.NIGHTLY_PERSONAL_GITHUB_TOKEN }}
          pull-request-number: ${{ steps.createpr.outputs.pull-request-number }}
          merge-method: squash
